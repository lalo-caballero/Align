---
title: "Workflow POW"
output:
  "BiocStyle::html_document":
    dev: png
  "BiocStyle::pdf_document":
    latex_engine: lualatex
    df_print: "kable"
    dev: png
package: pow
author: "pow authors"
date: "`r format(Sys.Date(), '%F')`"
abstract: >
  An introduction to the workflow to optimize and apply the POW algotithm to a
  dataset
vignette: >
  %\VignetteIndexEntry{Workflow_POW}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(pow)
library(ggplot2)
library(BiocParallel)
register(SnowParam(workers = 2, 
                   progressbar =interactive() && 
                     is.null(getOption("knitr.in.progress")), 
                   exportglobals = FALSE), 
         default = TRUE)
```

```{r}
p <- 10
lambda2_min <- -2
lambda2_max <- 4
L <- 31
```

```{r}
#samples_dir <- "/storage/projects/Alignment/data_to_test_nptw/gaschrom/data_gaschrom.csv"
#data <- read.csv(samples_dir, header = FALSE)
```

```{r load ketones}
# library(GCIMS)
# samples_directory<- "/storage/projects/TargetML/KETONES"
# annotations <- read.csv(file.path(samples_directory,"annotations.csv"))
# annotations <- annotations[-c(26,27,32,34,36,37,38),]
# dataset1 <- GCIMSDataset$new(
#   annotations,
#   base_dir = samples_directory,
#   on_ram = FALSE
# )
# filterRt(dataset1, rt = c(0, 1500)) # in s
# filterDt(dataset1, dt = c(5, 16)) # in ms
# dataset1 <- smooth(dataset1, rt_length_s = 3, dt_length_ms = 0.14)
# decimate(dataset1, rt_factor = 1, dt_factor = 2)
# align_ip(dataset1)
# dataset1$realize()
# data <- dataset1$getRIC()
```

```{r}
set.seed(100)
data <- create_synthetic_dataset(n_samples = 15,
                                 n_peaks = 10,
                                 length_out = 1500,
                                 mov_peaks = 5,
                                 intensity = 500,
                                 random_intensity = 50)
```

```{r}
idx_y <- select_reference(data)
X <- as.matrix(data[-idx_y,])
y <- as.matrix(data[idx_y,])
n_samples <- nrow(X)
m <- length(y)
v <- rep(1,m)
iv <- seq(2, m - 1, by = p)
v[iv] <- 0
W <- Matrix::Diagonal(x = v)
```

```{r}
lambdas <- pracma::logspace(lambda2_min,lambda2_max,L)
val<-compute_val_error(X,y,W,iv,lambdas)
e_ix <- val$e_ix
ti_ix <- val$ti_ix
opar = optimize_params(n_samples, lambdas, ti_ix, e_ix)
best_lambdas2 <- opar$best_params
#lambdas2_idx <- opar$params_idx
```

```{r}
XW <- apply_pow(X, best_lambdas2, y)
```

```{r}
df_align <- data.frame(t(XW))
df_align <- cbind(df_align,T=c(1:nrow(df_align)))
df_align <- reshape2::melt(df_align,"T")
a<-ggplot(data=df_align, aes(x=T, y=value, col=variable))+geom_line()+guides(colour="none")

df_pre_align <- data.frame(t(X))
df_pre_align <- cbind(df_pre_align,T=c(1:nrow(df_pre_align)))
df_pre_align <- reshape2::melt(df_pre_align,"T")
b<-ggplot(data=df_pre_align, aes(x=T, y=value, col=variable))+geom_line()+guides(colour="none")
cowplot::plot_grid(a,b)
```

```{r}
image(c(1:m),c(1:n_samples),t(XW),col=hcl.colors(10, "Grays"))
```

```{r}
image(c(1:m),c(1:(n_samples+1)),t(data),col=hcl.colors(10, "Grays"))
```



